name: Test Kernel

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/kernel/**'
      - 'src/tsl/**'
      - 'src/thdl/**'
  pull_request:
    branches: [main]
    paths:
      - 'src/kernel/**'
      - 'src/tsl/**'
      - 'src/thdl/**'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check kernel exists
        id: check
        run: |
          if [ -f "src/kernel/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Kernel source not yet published. Skipping tests."
          fi

      - name: Install Rust toolchain
        if: steps.check.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        if: steps.check.outputs.exists == 'true'
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache cargo
        if: steps.check.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/kernel/target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('src/kernel/Cargo.lock') }}

      - name: Run kernel tests with coverage
        if: steps.check.outputs.exists == 'true'
        working-directory: src/kernel
        run: |
          cargo llvm-cov --all-features --lcov --output-path lcov.info
          cargo llvm-cov report --all-features

      - name: Run TSL compiler tests
        if: steps.check.outputs.exists == 'true'
        working-directory: src/tsl
        continue-on-error: true
        run: cargo test --all-features || true

      - name: Run THDL synthesizer tests
        if: steps.check.outputs.exists == 'true'
        working-directory: src/thdl
        continue-on-error: true
        run: cargo test --all-features || true

      - name: Upload coverage
        if: steps.check.outputs.exists == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: src/kernel/lcov.info
          flags: kernel
          fail_ci_if_error: false

  feature-matrix:
    name: Feature Matrix Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features:
          - ""
          - "finra-613"

    steps:
      - uses: actions/checkout@v4

      - name: Check kernel exists
        id: check
        run: |
          if [ -f "src/kernel/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Kernel source not yet published. Skipping feature matrix tests."
          fi

      - name: Install Rust toolchain
        if: steps.check.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Test with features (${{ matrix.features }})
        if: steps.check.outputs.exists == 'true'
        working-directory: src/kernel
        run: |
          if [ -z "${{ matrix.features }}" ]; then
            cargo test
          else
            cargo test --features "${{ matrix.features }}"
          fi

  feature-matrix-build-only:
    name: Feature Matrix Build Check (no_std)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features:
          - "no_std"
          - "fpga"
          - "asic"

    steps:
      - uses: actions/checkout@v4

      - name: Check kernel exists
        id: check
        run: |
          if [ -f "src/kernel/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Kernel source not yet published. Skipping build check."
          fi

      - name: Install Rust toolchain
        if: steps.check.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Build check with features (${{ matrix.features }})
        if: steps.check.outputs.exists == 'true'
        working-directory: src/kernel
        run: cargo build --features "${{ matrix.features }}"

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check kernel exists
        id: check
        run: |
          if [ -f "src/kernel/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Kernel source not yet published. Skipping benchmarks."
          fi

      - name: Install Rust toolchain
        if: steps.check.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Run benchmarks
        if: steps.check.outputs.exists == 'true'
        working-directory: src/kernel
        run: cargo bench --all-features 2>/dev/null || echo "Benchmarks not yet configured"

  miri:
    name: Miri (Undefined Behavior Detection)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check kernel exists
        id: check
        run: |
          if [ -f "src/kernel/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Kernel source not yet published. Skipping Miri."
          fi

      - name: Install Rust nightly + Miri
        if: steps.check.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri

      - name: Run Miri on kernel
        if: steps.check.outputs.exists == 'true'
        working-directory: src/kernel
        run: |
          cargo +nightly miri test 2>&1 | tee miri-output.log
          MIRI_EXIT=${PIPESTATUS[0]}
          if [ $MIRI_EXIT -ne 0 ]; then
            echo "::warning::Miri detected potential undefined behavior (exit code $MIRI_EXIT)"
            echo "Review miri-output.log for details"
            cat miri-output.log
            exit 1
          fi
